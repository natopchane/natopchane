<!DOCTYPE html>

<html lang="ru">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<!-- Шрифты -->
<link crossorigin="true" href="https://fonts.googleapis.com" rel="preconnect"/>
<link crossorigin="true" href="https://fonts.gstatic.com" rel="preconnect"/>
<link crossorigin="true" href="https://www.youtube-nocookie.com" rel="preconnect"/>
<link crossorigin="true" href="https://i.ytimg.com" rel="preconnect"/>
<link href="https://fonts.googleapis.com/css2?family=Jura:wght@600;700&amp;display=swap" rel="stylesheet"/>
<link href="https://fonts.googleapis.com/css2?family=Great+Vibes&amp;display=swap" rel="stylesheet"/>
<link href="https://fonts.googleapis.com/css2?family=Neucha&amp;family=Great+Vibes&amp;display=swap" rel="stylesheet"/>
<link href="https://fonts.googleapis.com/css2?family=Philosopher&amp;display=swap" rel="stylesheet"/>
<link href="css/style.css" rel="stylesheet"/>
<title>На ТОПчане — Персидский Мир</title>
<meta content="Новости, культура, музыка и жизнь Персии — всё в одном месте. Персидский Мир на ТОПчане." name="description"/>
<meta content="website" property="og:type"/>
<meta content="На ТОПчане — Персидский Мир" property="og:title"/>
<meta content="Новости, культура, музыка и жизнь Персии — всё в одном месте." property="og:description"/>
<meta content="https://natopchane.github.io/natopchane/images/preview.jpg" property="og:image"/>
<meta content="https://natopchane.github.io/natopchane/" property="og:url"/>
<meta content="summary_large_image" name="twitter:card"/>
<meta content="На ТОПчане — Персидский Мир" name="twitter:title"/>
<meta content="Новости, культура, музыка и жизнь Персии — всё в одном месте." name="twitter:description"/>
<meta content="https://natopchane.github.io/natopchane/images/preview.jpg" name="twitter:image"/>
<meta content="#0ea5e9" name="theme-color"/>
<link href="images/icon.svg" rel="icon" type="image/svg+xml">
<link href="https://natopchane.github.io/natopchane/" rel="canonical">
<link href="manifest.webmanifest" rel="manifest">
<!-- Tailwind -->
<script src="https://cdn.tailwindcss.com"></script>
<script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: { sans: ['-apple-system','BlinkMacSystemFont','Segoe UI','Roboto','sans-serif'] }
        }
      }
    }
  </script>
<!-- Общие стили -->
<link href="css/style.css?v=2" rel="stylesheet">
<!-- Локальные стили страницы -->
<style>
    html { scroll-behavior:smooth }
    body { padding-bottom:64px }
    a { transition:color .2s ease, opacity .2s ease }
    a:hover { opacity:.7 }
    header nav a { font-weight:500 }
    header nav a.active { border-bottom:2px solid currentColor }
    .mobile-nav{display:none}
    @media (max-width:768px){ nav{display:none} .mobile-nav{display:block} }
    .btn{padding:10px 14px;border-radius:10px;border:1px solid #e5e7eb}
    .btn-primary{background:#2563eb;color:#fff;border-color:#2563eb}
    .btn-ghost{background:#fff}
    .input{width:100%;border:1px solid #e5e7eb;border-radius:10px;padding:10px 12px}

    /* Заголовки секций */
    .section-title{display:flex;align-items:center;gap:.75rem;margin:2rem 0 .5rem;font-weight:700;letter-spacing:.2px}
    .section-title h2{font-size:1.25rem}
    .section-title .dot{width:8px;height:8px;border-radius:9999px;background:#0f172a;box-shadow:0 0 0 4px rgba(15,23,42,.08)}
    .section-sub{color:#64748b;font-size:.9rem}

    /* Разделитель секций */
    .section-divider{height:1px;background:linear-gradient(90deg,transparent,#e5e7eb,transparent);margin:.5rem 0 1.25rem}

    /* Сетка карточек 3 в ряд */
    .cards{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:1rem}
    @media (max-width:900px){.cards{grid-template-columns:repeat(2,minmax(0,1fr))}}
    @media (max-width:640px){.cards{grid-template-columns:1fr}}

    /* Карточка */
    .card{border:1px solid #e5e7eb;border-radius:14px;overflow:hidden;background:#fff;box-shadow:0 10px 24px rgba(0,0,0,.04)}
    .card .body{padding:12px}
    .card h3{font-weight:600;margin-bottom:.25rem}
    .card p{color:#64748b;font-size:.9rem}

    /* Пагинация */
    .pager{display:flex;gap:.4rem;margin-top:12px}
    .pager button{min-width:34px;height:34px;border:1px solid #e5e7eb;border-radius:8px;background:#fff}
    .pager button.active{background:#0f172a;color:#fff;border-color:#0f172a}
    .pager button:disabled{opacity:.4;cursor:not-allowed}

    /* Хиро */
    .welcome-title{font-family:'Philosopher',sans-serif;font-weight:700;font-size:clamp(36px,5vw,60px);margin-bottom:.4rem;color:#0f172a}
    .welcome-text{font-family:'Great Vibes',cursive;font-size:clamp(18px,2.2vw,28px);color:black;display:inline-block;position:relative;overflow:hidden;background:linear-gradient(to right,black 0%,black 40%,gold 50%,black 60%,black 100%);background-size:200% auto;-webkit-background-clip:text;-webkit-text-fill-color:transparent;animation:letterShine 10s ease-in-out infinite}
    @keyframes letterShine{0%{background-position:-200% center}100%{background-position:200% center}}

    /* ВИДЕО-карточки */
    .yt-card{border:1px solid #e5e7eb;border-radius:16px;background:#fff;overflow:hidden;box-shadow:0 10px 24px rgba(0,0,0,.06);transition:transform .25s ease, box-shadow .25s ease, border-color .25s ease;opacity:0;transform:translateY(10px)}
    .yt-card:hover{transform:translateY(-4px);box-shadow:0 18px 38px rgba(0,0,0,.12);border-color:#e2e8f0}
    .yt-thumb{position:relative;background:#000;aspect-ratio:16/9}
    .yt-thumb iframe{position:absolute;inset:0;width:100%;height:100%}
    .yt-skel{position:absolute;inset:0;background:#0a0a0a}
    .yt-skel:after{content:"";position:absolute;inset:0;background:linear-gradient(90deg,rgba(255,255,255,.06),rgba(255,255,255,.2),rgba(255,255,255,.06));transform:translateX(-100%);animation:shimmer 1.3s infinite}
    @keyframes shimmer{to{transform:translateX(100%)}}
    .yt-body{padding:12px}
    .yt-title{font-weight:600;margin-bottom:.25rem;line-height:1.25;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden}
    .yt-desc{color:#64748b;font-size:.9rem;line-height:1.35;display:-webkit-box;-webkit-line-clamp:3;-webkit-box-orient:vertical;overflow:hidden}

    /* Плавное появление */
    .reveal{opacity:0;transform:translateY(12px);transition:opacity .6s ease, transform .6s ease}
    .reveal.in{opacity:1;transform:none}

    /* Скелетон для новостей */
    .news-skel{border:1px solid #e5e7eb;border-radius:14px;overflow:hidden;background:#fff;box-shadow:0 10px 24px rgba(0,0,0,.04)}
    .news-skel .ph{height:12px;background:#f1f5f9;border-radius:8px}
    .news-skel .ph.media{height:0;padding-bottom:56.25%;background:#0b0b0b;position:relative;overflow:hidden}
    .news-skel .ph.media::after{content:"";position:absolute;inset:0;background:linear-gradient(90deg,rgba(255,255,255,.06),rgba(255,255,255,.2),rgba(255,255,255,.06));animation:shimmer 1.3s infinite;transform:translateX(-100%)}

    .sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0}
    :focus-visible{outline:2px solid #0ea5e9;outline-offset:2px}
    @media (prefers-reduced-motion: reduce){*{animation:none!important;transition:none!important}}
    /* ===== Мобильный вид при любой ширине окна меньше 768px ===== */
@media (max-width: 768px) {
  footer { display: none !important; }
  #menu-btn { display: inline-flex !important; }
  nav ul { display: none !important; }
  header img {
    max-height: 32px;
    height: auto;
    max-width: 100%;
    display: block;
    object-fit: contain;
  }
}

  </style>
<!-- Schema.org -->
<script type="application/ld+json">
  {"@context":"https://schema.org","@type":"Organization","name":"На ТОПчане","url":"https://natopchane.example","logo":"https://natopchane.example/images/logo.png","sameAs":["https://www.youtube.com/@natopchane","https://t.me/na_topchane"]}
  </script>
<script type="application/ld+json">
  {"@context":"https://schema.org","@type":"WebSite","url":"https://natopchane.example","potentialAction":{"@type":"SearchAction","target":"https://natopchane.example/search?q={query}","query-input":"required name=query"}}
  </script>
<style>
.ad-left, .ad-right {
    position: fixed;
    top: 100px;
    z-index: 9999;
}
.ad-left {
    left: 10px;
}
.ad-right {
    right: 10px;
}
@media (max-width: 1024px) {
    .ad-left, .ad-right { display: none; }
}

</style>
</link></link></link><style>
/* ===== MOBILE FIXES (injected) ===== */
@media (max-width: 768px){
  body{ padding-bottom: 0 !important; }
  footer{ display: none !important; }
  header img{ max-height: 32px; height: auto; max-width: 100%; display: block; object-fit: contain; }
}

#menu{ max-height: 0; opacity: 0; overflow: hidden; transition: max-height .3s ease, opacity .2s ease; }
#menu.open{ max-height: 70vh; opacity: 1; }

#menu-backdrop{ position: fixed; inset: 0; background: rgba(0,0,0,.4); }
@media (min-width: 768px){ #menu-backdrop{ display: none !important; } }
</style></link></head>
<body class="bg-white text-gray-900 font-sans">
<a class="sr-only focus:not-sr-only focus:fixed focus:top-2 focus:left-2 focus:z-50 bg-white border rounded px-3 py-1 shadow" href="#home-videos">Перейти к контенту</a>
<!-- ====== HEADER ====== -->
<header class="border-b border-gray-200 bg-white">
<style>header nav a.active{border-bottom: 2px solid currentColor;padding-bottom: 2px}</style>
<div class="w-full px-2 flex justify-between items-center h-16">
<a class="flex items-center gap-2 text-xl font-semibold tracking-tight" href="">
<img alt="На ТОПчане" class="shrink-0 w-8 align-middle h-8 object-contain inline-block" decoding="async" height="32" loading="eager" src="images/logo.png" style="display:block;max-width:100%" width="32"/> На ТОПчане
      </a>
<!-- Десктоп-меню -->
<nav class="hidden md:flex md:flex-1 justify-center items-center gap-8 whitespace-nowrap">
<a href="">Главная</a>
<a href="news.html">Новости</a>
<a href="ads.html">Реклама</a>
<a href="videos.html">Видео</a>
<a href="gallery.html">Галерея</a>
<a href="biographies.html">Биографии</a>
<a href="music.html">Музыка</a>
<a href="entertainment.html">Развлечения</a>
<a href="products.html">Продукция</a>
<a href="about.html">О нас</a>
<a href="contacts.html">Контакты</a>
</nav>
<!-- Бургер -->
<button aria-label="Меню" class="md:hidden p-2 text-gray-700 text-2xl" id="menu-btn">☰</button>
</div><div class="hidden md:hidden" id="menu-backdrop"></div>
<!-- Мобильное меню -->
<div class="hidden flex-col gap-4 p-4 bg-gray-100 md:hidden" id="menu">
<a href="">Главная</a>
<a href="news.html">Новости</a>
<a href="ads.html">Реклама</a>
<a href="videos.html">Видео</a>
<a href="gallery.html">Галерея</a>
<a href="biographies.html">Биографии</a>
<a href="music.html">Музыка</a>
<a href="entertainment.html">Развлечения</a>
<a href="products.html">Продукция</a>
<a href="about.html">О нас</a>
<a href="contacts.html">Контакты</a>
</div>
</header>
<!-- КОНТЕНТ -->
<main class="max-w-7xl mx-auto p-4">
<!-- HERO -->
<section class="text-center py-16">
<h1 class="welcome-title">Добро пожаловать в Персидский Мир</h1>
<p><span class="welcome-text">Откройте для себя новости, культуру, музыку и всё, что связано с величественной Персией.</span></p>
</section>
<!-- ВИДЕО НА ГЛАВНОЙ -->
<section class="reveal" id="home-videos">
<div class="section-title">
<span class="dot"></span><h2>Последние Выпуски</h2>
<span class="section-sub">+ Эксклюзивы</span>
</div>
<!-- Полоска категорий -->
<div class="flex flex-wrap gap-2 mb-3" id="cat-strip"></div>
<div class="section-divider"></div>
<div class="cards" id="featured-videos"></div>
<div class="pager" id="featured-videos-pager"></div>
</section>
<!-- ПОСЛЕДНИЕ НОВОСТИ -->
<section id="home-news">
<div class="section-title">
<span class="dot"></span><h2>Последние новости</h2>
<span class="section-sub">самые свежие публикации</span>
</div>
<div class="section-divider"></div>
<div class="cards" id="latest-news"></div>
<div class="pager" id="latest-news-pager"></div>
</section>
</main>
<!-- ПОДВАЛ с кнопками модалки -->
<footer class="fixed bottom-0 left-0 w-full border-t border-gray-200 bg-white">
<div class="max-w-7xl mx-auto px-4 py-2 text-xs text-gray-500 flex flex-col md:flex-row justify-between items-center gap-2">
<p>© 2025 На ТОПчане. Все права защищены.</p>
<ul class="soc-row">
<li><a aria-label="VK" href="https://vk.com/natopchane" target="_blank"><img alt="VK" src="images/soc/vk.svg"/></a></li>
<li><a aria-label="Telegram" href="https://t.me/na_topchane" target="_blank"><img alt="Telegram" src="images/soc/telegram.svg"/></a></li>
<li><a aria-label="Instagram" href="https://www.instagram.com/natopchane/" target="_blank"><img alt="Instagram" src="images/soc/instagram.svg"/></a></li>
<li><a aria-label="TikTok" href="https://www.tiktok.com/@natopchane" target="_blank"><img alt="TikTok" src="images/soc/tik-tok.svg"/></a></li>
<li><a aria-label="Pinterest" href="https://www.pinterest.com/natopchane/?invite_code=67d18b04667e4a56b03fb7432127235b&amp;sender=1144266355231499314" target="_blank"><img alt="Pinterest" src="images/soc/pinterest.svg"/></a></li>
<li><a aria-label="Rutube" href="https://rutube.ru/channel/49549724/" target="_blank"><img alt="Rutube" src="images/soc/rutube.svg"/></a></li>
<li><a aria-label="Facebook" href="https://www.facebook.com/groups/natopchane/" target="_blank"><img alt="Facebook" src="images/soc/fb.svg"/></a></li>
<li><a aria-label="Dzen" href="https://dzen.ru/natopchane" target="_blank"><img alt="Dzen" src="images/soc/yandex.svg"/></a></li>
<li><a aria-label="YouTube" href="https://www.youtube.com/@natopchane" target="_blank"><img alt="YouTube" src="images/soc/youtube.svg"/></a></li>
<li><a aria-label="OK" href="https://ok.ru/group/70000013841187" target="_blank"><img alt="OK" src="images/soc/ok.svg"/></a></li>
</ul>
<div class="flex flex-wrap gap-3">
<button class="hover:underline" id="terms-btn">Пользовательское соглашение</button>
<button class="hover:underline" id="support-btn">Поддержка</button>
<button class="hover:underline" id="cooperation-btn">Сотрудничество</button>
<button class="hover:underline" id="privacy-btn">Политика конфиденциальности</button>
</div>
<!-- ЕДИНСТВЕННЫЙ СЧЁТЧИК В ПОДВАЛЕ -->
<p>👁 <span id="visit-counter">0</span> посещений</p>
</div>
</footer>
<!-- УНИВЕРСАЛЬНАЯ МОДАЛКА -->
<div class="fixed inset-0 bg-black/50 hidden z-50 flex items-center justify-center p-4" id="modal-overlay">
<button class="absolute left-4 md:left-6 top-1/2 -translate-y-1/2 bg-white/90 hover:bg-white rounded-full w-9 h-9 flex items-center justify-center shadow" id="prev-article">‹</button>
<button class="absolute right-4 md:right-6 top-1/2 -translate-y-1/2 bg-white/90 hover:bg-white rounded-full w-9 h-9 flex items-center justify-center shadow" id="next-article">›</button>
<div class="bg-white article-modal w-full max-w-[880px] p-0 rounded-2xl relative shadow-lg" id="modal-box">
<button class="absolute top-3 right-3 text-gray-500 hover:text-gray-700 text-2xl leading-none" id="modal-close">×</button>
<div class="article-scroll">
<img alt="" class="article-cover hidden" id="article-cover"/>
<div class="p-6">
<h2 class="text-2xl font-bold mb-1" id="modal-title"></h2>
<div class="flex flex-wrap items-center gap-3 mb-4">
<div class="text-xs text-gray-500" id="modal-meta"></div>
<div class="ml-auto flex items-center gap-2 text-xs">
<button class="btn btn-ghost py-1 px-2" id="share-copy">Скопировать ссылку</button>
<a class="btn btn-ghost py-1 px-2" id="share-tg" rel="noopener" target="_blank">TG</a>
<a class="btn btn-ghost py-1 px-2" id="share-vk" rel="noopener" target="_blank">VK</a>
</div>
</div>
<div class="prose text-gray-800" id="modal-content"></div>
</div>
</div>
</div>
</div>
<!-- UI скрипты -->
<script>
    document.getElementById('menu-btn')?.addEventListener('click', () => {
      document.getElementById('menu')?.classList.toggle('hidden');
    });

    // Поиск по карточкам на главной (по тексту) — если будет инпут footer-search
    (function(){
      const input = document.getElementById('footer-search');
      if(!input) return;
      input.addEventListener('input', ()=>{
        const q=(input.value||'').toLowerCase();
        document.querySelectorAll('#featured-videos .yt-card, #latest-news .card').forEach(card=>{
          const txt=(card.textContent||'').toLowerCase();
          card.style.display = txt.includes(q)?'':'none';
        });
      });
    })();

    // Reveal-анимация
    const io = new IntersectionObserver((ents)=>{
      ents.forEach(e=>{ if(e.isIntersecting){ e.target.classList.add('in'); io.unobserve(e.target); } });
    },{threshold:.12});
    document.querySelectorAll('.reveal').forEach(el=>io.observe(el));
  </script>
<!-- Lazy YouTube клик -->
<script>
    document.addEventListener('click', function(e){
      const t = e.target.closest('.yt-thumb');
      if(!t) return;
      const card = t.closest('[data-yt]');
      if(!card) return;
      const id = card.getAttribute('data-yt');
      t.outerHTML = `<div class="relative aspect-[16/9]">
          <iframe src="https://www.youtube-nocookie.com/embed/${id}?autoplay=1" title="YouTube video"
            allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
            allowfullscreen class="absolute inset-0 w-full h-full"></iframe>
        </div>`;
    });
  </script>
<!-- Service Worker -->
<script>
    if('serviceWorker' in navigator){
      window.addEventListener('load',()=>{navigator.serviceWorker.register('sw.js').catch(()=>{});});
    }
  </script>
<!-- Firebase compat -->
<script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore-compat.js"></script>
<!-- Главная логика: категории, фиды, счетчики, метрики -->
<script>
  (function(){
    const firebaseConfig = {
      apiKey: "AIzaSyDKtZC_EtbvXfIMR9RcFJRQKOvWFWbzVpc",
      authDomain: "na-topchane.firebaseapp.com",
      projectId: "na-topchane",
      storageBucket: "na-topchane.appspot.com",
      messagingSenderId: "238607307862",
      appId: "1:238607307862:web:affd25f2039fc67e1d17f7",
      measurementId: "G-ZNYNDR5P3F"
    };
    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    /* Полоска категорий */
    const CATS = ['ПОСЛЕДНИЕ','ПОЭЗИЯ','ДАСТАРХАН','ШЁЛКОВЫЙ ПУТЬ','БИОГРАФИИ','МУЗЫКА','PRO TJK','ENGLISH','МИСТИКА'];
    const strip = document.getElementById('cat-strip');
    if (strip) strip.innerHTML = CATS.map(c => (
      `<a href="videos.html?cat=${encodeURIComponent(c)}" class="px-3 py-1 rounded-full border text-sm">${c}</a>`
    )).join('');

    /* Renderers */
    const renderVideo = (v)=> {
      const title = (v.title||'').trim();
      const desc  = (v.desc||'').replace(/<[^>]+>/g,' ').replace(/\s+/g,' ').trim();
      const snip  = desc.length>230 ? (desc.slice(0,227)+'…') : desc;
      const embed = (v.embed||'').replace('autoplay=1','autoplay=0');
      return `
        <article class="yt-card">
          <div class="yt-thumb">
            <div class="yt-skel"></div>
            <iframe loading="lazy" src="${embed}" frameborder="0" allowfullscreen
              onload="this.previousElementSibling && this.previousElementSibling.remove()"></iframe>
          </div>
          <div class="yt-body">
            <h3 class="yt-title">${title}</h3>
            ${snip ? `<p class="yt-desc">${snip}</p>` : ''}
          </div>
        </article>`;
    };
    const renderNews = (n)=>`
      <article class="card">
        ${n.cover ? `<img src="${n.cover}" alt="" class="w-full aspect-[16/9] object-cover">` : ''}
        <div class="body">
          <h3>${n.title||'Без названия'}</h3>
          <p>${(n.html||'').replace(/<[^>]+>/g,' ').slice(0,160)}...</p>
        </div>
      </article>`;

    function makePager({wrapId, pagerId, coll, whereField, whereValue, orderField, renderCard}){
      const wrap  = document.getElementById(wrapId);
      const pager = document.getElementById(pagerId);
      const PAGE_SIZE = 3;
      let cursors = [];
      let page = 1;

      async function load(p=1){
        page = p;
        const isNews = wrapId === 'latest-news';
        wrap.innerHTML = isNews
          ? `${Array.from({length:PAGE_SIZE}).map(()=>`
              <article class="news-skel">
                <div class="ph media"></div>
                <div class="p-4 space-y-2">
                  <div class="ph w-3/4"></div><div class="ph w-full"></div><div class="ph w-2/3"></div>
                </div>
              </article>`).join('')}`
          : `${Array.from({length:PAGE_SIZE}).map(()=>`
              <article class="yt-card">
                <div class="yt-thumb"><div class="yt-skel"></div></div>
                <div class="yt-body">
                  <div class="h-5 w-4/5 bg-gray-100 rounded mb-2 animate-pulse"></div>
                  <div class="h-4 w-full bg-gray-100 rounded mb-1 animate-pulse"></div>
                  <div class="h-4 w-3/5 bg-gray-100 rounded animate-pulse"></div>
                </div>
              </article>`).join('')}`;
        try{
          let q = db.collection(coll);
          if (whereField) q = q.where(whereField, '==', whereValue);
          q = q.orderBy(orderField, 'desc').limit(PAGE_SIZE);
          if (page>1 && cursors[page-2]) q = q.startAfter(cursors[page-2]);
          const snap = await q.get();
          const docs = snap.docs;
          if (docs.length) cursors[page-1] = docs[docs.length-1];
          wrap.innerHTML = '';
          docs.forEach(d => wrap.insertAdjacentHTML('beforeend', renderCard(d.data())));
          if (!docs.length) wrap.innerHTML = '<div class="text-sm text-gray-500">Пока пусто</div>';
          requestAnimationFrame(()=>{
            wrap.querySelectorAll('.yt-card').forEach((el,i)=>{
              setTimeout(()=>{ el.style.opacity=1; el.style.transform='none'; }, 60*i);
            });
          });
          renderPager(docs.length === PAGE_SIZE);
        }catch(e){
          console.error(e);
          wrap.innerHTML = '<div class="text-sm text-red-600 p-3">Ошибка загрузки данных.</div>';
        }
      }
      function renderPager(hasNext){
        const knownPages = Math.max(page, cursors.filter(Boolean).length + (hasNext ? 1 : 0));
        pager.innerHTML = '';
        for(let i=1;i<=knownPages;i++){
          const b = document.createElement('button');
          b.textContent=i; if(i===page) b.classList.add('active');
          b.onclick=()=>load(i); pager.appendChild(b);
        }
        const next = document.createElement('button');
        next.textContent='»'; next.disabled=!hasNext; next.onclick=()=>load(page+1); pager.appendChild(next);
      }
      return { load };
    }

    const pv = makePager({wrapId:'featured-videos', pagerId:'featured-videos-pager', coll:'videos', whereField:'featured', whereValue:true, orderField:'createdAt', renderCard:renderVideo});
    const pn = makePager({wrapId:'latest-news', pagerId:'latest-news-pager', coll:'news', whereField:'status', whereValue:'published', orderField:'createdAt', renderCard:renderNews});
    pv.load(1); pn.load(1);

    /* COUNTER: +1 на каждый визит, живое обновление в подвале */
    const ref = db.collection('siteViews').doc('home');
    const el  = document.getElementById('visit-counter');
    ref.set({ count: 0 }, { merge: true }).catch(()=>{});
    db.runTransaction(async (tx) => {
      const snap = await tx.get(ref);
      const curr = (snap.exists && Number.isInteger(snap.data().count)) ? snap.data().count : 0;
      tx.update(ref, { count: curr + 1 });
    }).catch(console.error);
    ref.onSnapshot(
      (snap) => { if (snap.exists && el) el.textContent = (snap.data().count || 0); },
      () => { if (el) el.textContent = '—'; }
    );

  })();
  </script>
<!-- lazy-news-images -->
<script>
  (function(){
    function apply(){
      document.querySelectorAll('#latest-news img').forEach(function(img){
        if(!img.loading) img.loading = 'lazy';
      });
    }
    apply();
    var wrap = document.getElementById('latest-news');
    if(wrap){
      var obs = new MutationObserver(apply);
      obs.observe(wrap, {childList:true, subtree:true});
    }
  })();
  </script>
<!-- uniques-per-day -->
<script>
  (function(){
    try{
      var db = firebase && firebase.firestore && firebase.firestore();
      if(!db) return;
      var day = new Date().toISOString().slice(0,10);
      var key = 'uniqueSeen-'+day;
      if(!localStorage.getItem(key)){
        localStorage.setItem(key,'1');
        db.collection('siteUniques').doc(day)
          .set({count: firebase.firestore.FieldValue.increment(1)}, {merge:true})
          .catch(function(){});
      }
    }catch(e){}
  })();
  </script>
<!-- client-error-logger -->
<script>
  (function(){
    try{
      var db = firebase && firebase.firestore && firebase.firestore();
      if(!db) return;
      function log(kind, msg, src, line, col, err){
        db.collection('clientErrors').add({
          kind, message: String(msg||''), source: String(src||location.href),
          line: Number(line||0), col: Number(col||0),
          stack: err && err.stack ? String(err.stack) : null,
          ua: navigator.userAgent, path: location.pathname, ts: new Date()
        }).catch(function(){});
      }
      window.addEventListener('error', function(e){ log('error', e.message, e.filename, e.lineno, e.colno, e.error); });
      window.addEventListener('unhandledrejection', function(e){ log('unhandledrejection', (e.reason && e.reason.message)||e.reason, '', 0, 0, e.reason); });
    }catch(e){}
  })();
  </script>
<!-- web-vitals-push -->
<script src="https://unpkg.com/web-vitals@3/dist/web-vitals.umd.js"></script>
<script>
  (function(){
    try{
      var db = firebase && firebase.firestore && firebase.firestore();
      if(!db || !window.webVitals) return;
      function push(m){
        db.collection('webVitals').add({
          name: m.name, value: m.value, id: m.id, rating: m.rating,
          path: location.pathname, ts: new Date()
        }).catch(function(){});
      }
      webVitals.onLCP(push); webVitals.onCLS(push); webVitals.onINP(push);
    }catch(e){}
  })();
  </script>
<!-- UTM в ссылки шаринга (единственный блок) -->
<script>
  (function(){
    const apply = ()=>{
      const params = new URLSearchParams({utm_source:'site',utm_medium:'share',utm_campaign:'home_footer'});
      ['share-tg','share-vk'].forEach(id=>{
        const a = document.getElementById(id);
        if(!a || !a.href) return;
        try{
          const u = new URL(a.href, location.origin);
          params.forEach((v,k)=>u.searchParams.set(k,v));
          a.href = u.toString();
        }catch(e){}
      });
    };
    apply();
    document.addEventListener('DOMContentLoaded', apply);
  })();
  </script>
<!-- МОДАЛКА (контент и обработчики, как на ads.html) -->
<script>
  (function(){
    // безопасно пересоздаём обработчики, если что-то переинициализировалось
    ['terms-btn','support-btn','cooperation-btn','privacy-btn','menu-btn'].forEach(id=>{
      const el = document.getElementById(id);
      if(!el) return;
      const clone = el.cloneNode(true);
      el.parentNode.replaceChild(clone, el);
    });

    const modal=document.getElementById('modal-overlay');
    const title=document.getElementById('modal-title');
    const meta=document.getElementById('modal-meta');
    const content=document.getElementById('modal-content');
    const cover=document.getElementById('article-cover');
    const close=document.getElementById('modal-close');

    function show(t,html){
      if(!modal||!title||!content) return;
      title.textContent=t;
      if(meta) meta.textContent='';
      if(cover){ cover.classList.add('hidden'); cover.src=''; }
      content.innerHTML=html;
      modal.classList.remove('hidden');
    }

    close?.addEventListener('click', ()=> modal.classList.add('hidden'));
    modal?.addEventListener('click', e=>{ if(e.target===modal) modal.classList.add('hidden'); });
    document.addEventListener('keydown', e=>{ if(e.key==='Escape') modal.classList.add('hidden'); });

    const TERMS=`<p>Используя сайт «На ТОПчане», вы соглашаетесь с правилами:</p>
    <ul class="list-disc pl-5 space-y-1">
      <li>Не размещать незаконный или оскорбительный контент.</li>
      <li>Не использовать сайт для рассылки спама или мошенничества.</li>
      <li>Соблюдать авторские права на публикуемый материал.</li>
      <li>Администрация может изменять условия без предварительного уведомления.</li>
      <li>При несогласии с условиями прекратите использование сайта.</li>
    </ul>`;
    const SUPPORT=`<p>По любым вопросам и предложениям вы можете написать нам:</p>
    <p class="flex items-center gap-2">
      <img src="/images/soc/telegram.svg" alt="Telegram" class="w-5 h-5">
      <a href="https://t.me/levakand_pro" target="_blank" class="text-blue-600 hover:underline">Написать в Telegram</a>
    </p>`;
    const COOP=`<p>По вопросам рекламы и совместных проектов свяжитесь с нами:</p>
    <p class="flex items-center gap-2">
      <img src="/images/soc/telegram.svg" alt="Telegram" class="w-5 h-5">
      <a href="https://t.me/levakand_pro" target="_blank" class="text-blue-600 hover:underline">Telegram</a>
    </p>
    <p class="flex items-center gap-2">
      <img src="/images/soc/gmail.svg" alt="Gmail" class="w-5 h-5">
      <a href="mailto:natopchane@gmail.com" class="text-red-600 hover:underline">natopchane@gmail.com</a>
    </p>`;
    const PRIV=`<p>Мы уважаем вашу конфиденциальность. При использовании сайта «На ТОПчане» мы можем собирать минимальные данные: IP-адрес, cookie, email (при подписке на рассылку).</p>
    <p>Данные используются для улучшения работы сайта, персонализации контента и статистики посещений.</p>
    <p>Мы не передаём ваши данные третьим лицам, кроме случаев, предусмотренных законом.</p>
    <p>Вы можете запросить удаление или изменение своих данных, написав нам на <a class="text-red-600 hover:underline" href="mailto:natopchane@gmail.com">natopchane@gmail.com</a>.</p>
    <p>Изменения политики публикуются на этой странице.</p>`;

    document.getElementById('terms-btn')?.addEventListener('click', ()=> show('Пользовательское соглашение', TERMS));
    document.getElementById('support-btn')?.addEventListener('click', ()=> show('Поддержка', SUPPORT));
    document.getElementById('cooperation-btn')?.addEventListener('click', ()=> show('Сотрудничество и реклама', COOP));
    document.getElementById('privacy-btn')?.addEventListener('click', ()=> show('Политика конфиденциальности', PRIV));
  })();
  </script>
<!-- Левый боковой баннер -->
<div class="ad-left">
<script type="text/javascript">
	atOptions = {
		'key' : '4cfa40489284c0efa9eb342e77152cdc',
		'format' : 'iframe',
		'height' : 300,
		'width' : 160,
		'params' : {}
	};
</script>
<script src="//www.highperformanceformat.com/4cfa40489284c0efa9eb342e77152cdc/invoke.js" type="text/javascript"></script>
</div>
<!-- Правый боковой баннер -->
<div class="ad-right">
<script type="text/javascript">
	atOptions = {
		'key' : '766301ab751df8665553f47e1f05709a',
		'format' : 'iframe',
		'height' : 600,
		'width' : 160,
		'params' : {}
	};
</script>
<script src="//www.highperformanceformat.com/766301ab751df8665553f47e1f05709a/invoke.js" type="text/javascript"></script>
</div>
<script>
// ===== Mobile menu toggle (injected) =====
(function(){
  var btn = document.getElementById('menu-btn');
  var menu = document.getElementById('menu');
  var bd   = document.getElementById('menu-backdrop');
  if(!menu || !btn) return;

  function setOpen(state){
    if(state){
      menu.classList.add('open');
      menu.classList.remove('hidden');
      if(bd){ bd.classList.remove('hidden'); }
      document.body.style.overflow = 'hidden';
      btn.setAttribute('aria-expanded','true');
    }else{
      menu.classList.remove('open');
      setTimeout(function(){ menu.classList.add('hidden'); }, 300);
      if(bd){ bd.classList.add('hidden'); }
      document.body.style.overflow = '';
      btn.setAttribute('aria-expanded','false');
    }
  }
  function toggle(){ setOpen(!menu.classList.contains('open')); }

  // Remove old listeners by clone hack if needed
  try{
    var clone = btn.cloneNode(true);
    btn.parentNode.replaceChild(clone, btn);
    btn = document.getElementById('menu-btn');
  }catch(e){}

  btn.addEventListener('click', toggle);
  if(bd) bd.addEventListener('click', function(){ setOpen(false); });
  document.addEventListener('keydown', function(e){ if(e.key==='Escape') setOpen(false); });
})();
</script></body>
</html>
