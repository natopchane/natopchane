<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Видео — На ТОПчане | Персидский Мир</title>
  <link rel="icon" type="image/svg+xml" href="/images/video-icon.svg">
  <meta name="description" content="Смотрите новые видео На ТОПчане: Шёлковый путь, Поэзия, Музыка, Биографии, PRO TJK, Дастархан, English, Мистика.">
  <meta name="keywords" content="На ТОПчане, видео, Шёлковый путь, Поэзия, Музыка, Биографии, Дастархан, English, Мистика, PRO TJK">
  <meta name="theme-color" content="#ffffff">
  <script src="https://cdn.tailwindcss.com"></script>
<style>header nav a.active{border-bottom:2px solid currentColor}</style>
<style>
.ad-left, .ad-right {
    position: fixed;
    top: 100px;
    z-index: 9999;
}
.ad-left {
    left: 10px;
}
.ad-right {
    right: 10px;
}
</style>

</head>
<body class="bg-white text-gray-900 font-sans">

<!-- ====== HEADER (универсальный) ====== -->
<header class="border-b border-gray-200 bg-white">
  <style>
    /* Полоска под активным пунктом меню */
    header nav a.active{
      border-bottom: 2px solid currentColor;
      padding-bottom: 2px;
    }
    /* Ровные карточки без правки card() */
.card .p-4{display:flex;flex-direction:column}                 /* контент — флекс-колонка */
.card .p-4>.flex.items-center.justify-between:last-child{margin-top:auto} /* кнопки вниз */

/* Усечение заголовка и описания (только внутри карточки) */
.card h3{
  display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;
  overflow:hidden;text-overflow:ellipsis;
}
.card .p-4>p{
  display:-webkit-box;-webkit-line-clamp:4;-webkit-box-orient:vertical;
  overflow:hidden;text-overflow:ellipsis;unicode-bidi:plaintext;
}

/* одинаковая «шапка» у медиа (если где-то IMG вместо квадратов) */
.card img{display:block}

  </style>

  <div class="w-full px-2 flex justify-between items-center h-16">
    <a href="/" class="flex items-center gap-2 text-xl font-semibold tracking-tight">
      <img src="/images/logo.png" alt="На ТОПчане" class="h-8 w-8 object-contain">
      На ТОПчане
    </a>

    <!-- Десктоп-меню -->
    <nav class="hidden md:flex md:flex-1 justify-center items-center gap-8 whitespace-nowrap">
      <a href="/">Главная</a>
      <a href="/news.html">Новости</a>
      <a href="/ads.html">Реклама</a>
      <a href="/videos.html">Видео</a>
      <a href="/gallery.html">Галерея</a>
      <a href="/biographies.html">Биографии</a>
      <a href="/music.html">Музыка</a>
      <a href="/entertainment.html">Развлечения</a>
      <a href="/products.html">Продукция</a>
      <a href="/about.html">О&nbsp;нас</a>
      <a href="/contacts.html">Контакты</a>
    </nav>

    <!-- Бургер -->
    <button id="menu-btn" class="md:hidden p-2 text-gray-700 text-2xl" aria-label="Меню">☰</button>
  </div>

  <!-- Мобильное меню -->
  <div id="menu" class="hidden flex-col gap-4 p-4 bg-gray-100 md:hidden">
    <a href="/">Главная</a>
    <a href="/news.html">Новости</a>
    <a href="/ads.html">Реклама</a>
    <a href="/videos.html">Видео</a>
    <a href="/gallery.html">Галерея</a>
    <a href="/biographies.html">Биографии</a>
    <a href="/music.html">Музыка</a>
    <a href="/entertainment.html">Развлечения</a>
    <a href="/products.html">Продукция</a>
    <a href="/about.html">О нас</a>
    <a href="/contacts.html">Контакты</a>
  </div>

  <script>
    // Бургер
    document.getElementById('menu-btn')
      ?.addEventListener('click', ()=> document.getElementById('menu')?.classList.toggle('hidden'));

    // Авто-активный пункт (десктоп + мобилка)
    (function(){
      const norm = p => {
        try { p = new URL(p, location.origin).pathname; } catch(e){}
        if (p === '/index.html' || p === '') return '/';
        // убираем завершающий слеш кроме корня
        return p.length > 1 && p.endsWith('/') ? p.slice(0, -1) : p;
      };
      const cur = norm(location.pathname);
      document.querySelectorAll('header nav a, #menu a').forEach(a=>{
        const href = norm(a.getAttribute('href') || '');
        if (href === cur) {
          a.classList.add('active');
          a.setAttribute('aria-current','page');
        } else {
          a.classList.remove('active');
          a.removeAttribute('aria-current');
        }
      });
    })();
  </script>
</header>


<script>
document.getElementById('menu-btn').addEventListener('click', () => {
  document.getElementById('menu').classList.toggle('hidden');
});
</script>

<!-- Контент -->
<section class="max-w-7xl mx-auto p-4">
  <h1 class="flex items-center text-3xl font-bold mb-6">
    <img src="/images/hd.svg" alt="HD" class="h-8 w-8 mr-3">Видео
  </h1>

  <!-- Категории -->
  <div class="flex gap-4 overflow-x-auto pb-2 border-b border-gray-200 mb-6" id="video-cats">
    <button class="category-btn px-4 py-2 bg-blue-100 text-blue-700 rounded" data-cat="ПОСЛЕДНИЕ">ПОСЛЕДНИЕ</button>
    <button class="category-btn px-4 py-2 bg-gray-100 rounded" data-cat="ПОЭЗИЯ">ПОЭЗИЯ</button>
    <button class="category-btn px-4 py-2 bg-gray-100 rounded" data-cat="ДАСТАРХАН">ДАСТАРХАН</button>
    <button class="category-btn px-4 py-2 bg-gray-100 rounded" data-cat="ШЁЛКОВЫЙ ПУТЬ">ШЁЛКОВЫЙ ПУТЬ</button>
    <button class="category-btn px-4 py-2 bg-gray-100 rounded" data-cat="БИОГРАФИИ">БИОГРАФИИ</button>
    <button class="category-btn px-4 py-2 bg-gray-100 rounded" data-cat="МУЗЫКА">МУЗЫКА</button>
    <button class="category-btn px-4 py-2 bg-gray-100 rounded" data-cat="PRO TJK">PRO TJK</button>
    <button class="category-btn px-4 py-2 bg-gray-100 rounded" data-cat="ENGLISH">ENGLISH</button>
    <button class="category-btn px-4 py-2 bg-gray-100 rounded" data-cat="МИСТИКА">МИСТИКА</button>
  </div>

  <!-- Видео -->
  <div id="video-grid" class="grid md:grid-cols-4 gap-4"></div>
</section>

<!-- Модалка -->
<div id="video-modal" class="hidden fixed inset-0 bg-black/70 flex items-center justify-center z-50">
  <div class="bg-black rounded-lg overflow-hidden max-w-3xl w-full relative">
    <button id="close-modal" class="absolute top-2 right-2 text-white text-2xl">&times;</button>
    <iframe id="video-frame" class="w-full aspect-video" src="" allowfullscreen></iframe>
  </div>
</div>

<!-- Firestore -->
<script type="module">
  import { firebaseConfig } from './firebase-config.js';
  import { initializeApp, getApp, getApps } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
  import { getFirestore, collection, query, where, orderBy, limit, startAfter, getDocs } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

  const app = getApps().length ? getApp() : initializeApp(firebaseConfig);
  const db  = getFirestore(app);

  const grid   = document.getElementById('video-grid');
  const btns   = Array.from(document.querySelectorAll('.category-btn'));
  let currentCat = 'ПОСЛЕДНИЕ';
  let lastCursor = null;
  const PAGE_SIZE = 12;

  function card(v){
    return `
      <article class="border rounded overflow-hidden shadow hover:shadow-lg transition">
        <div class="aspect-video bg-black">
          <iframe class="w-full h-full" src="${v.embed}" frameborder="0" allowfullscreen></iframe>
        </div>
        <div class="p-3">
          <h3 class="font-semibold text-sm mb-1">${v.title||''}</h3>
          ${v.desc ? `<p class="text-xs text-gray-600 line-clamp-2">${v.desc}</p>` : ''}
        </div>
      </article>`;
  }

  function setActive(cat){
    btns.forEach(b=>{
      b.classList.remove('bg-blue-100','text-blue-700'); b.classList.add('bg-gray-100');
      if (b.dataset.cat===cat){ b.classList.add('bg-blue-100','text-blue-700'); b.classList.remove('bg-gray-100'); }
    });
  }

// ЗАМЕНИТЬ load(...) и renderMoreButton(...) ПОЛНОСТЬЮ НА ЭТО:

async function load(cat, reset = true){
  try{
    currentCat = cat;
    setActive(cat);

    if (reset){
      grid.innerHTML = '<div class="col-span-full py-6 text-gray-500">Загрузка…</div>';
      lastCursor = null; // сброс при смене категории
      const oldMore = document.getElementById('videos-more');
      if (oldMore) oldMore.style.display = 'none';
    }

    const NEED = PAGE_SIZE;  // сколько карточек хотим вывести за этот вызов
    let added = 0;
    let html  = '';

    // Читаем ленту по createdAt и фильтруем на клиенте (без композитных индексов)
    for (let safety = 0; added < NEED && safety < 6; safety++){
      let q = query(
        collection(db,'videos'),
        orderBy('createdAt','desc'),
        ...(lastCursor ? [startAfter(lastCursor)] : []),
        limit(50) // берём крупными пачками, чтобы после фильтра собрать NEED
      );

      const snap = await getDocs(q);
      if (snap.empty) break;

      const docs = snap.docs;
      lastCursor = docs[docs.length - 1];

      const filtered = docs
        .map(d => d.data())
        .filter(v => v && v.status === 'published' && (cat === 'ПОСЛЕДНИЕ' || v.category === cat));

      for (const v of filtered){
        if (added >= NEED) break;
        html += card(v);
        added++;
      }

      // если меньше 50 доков — дальше страниц нет
      if (docs.length < 50) break;
    }

    if (reset) grid.innerHTML = '';

    if (added === 0 && reset){
      grid.innerHTML = '<div class="col-span-full py-6 text-gray-500">Пока пусто</div>';
    } else {
      grid.insertAdjacentHTML('beforeend', html);
    }

    // Показать «Показать ещё», только если набрали полный PAGE_SIZE
    renderMoreButton(added === PAGE_SIZE);

  } catch(e){
    console.error(e);
    grid.innerHTML = `<div class="col-span-full py-6 text-red-600">Ошибка загрузки: ${e?.message || e}</div>`;
    renderMoreButton(false);
  }
}

function renderMoreButton(canMore){
  let more = document.getElementById('videos-more');
  if (!more){
    more = document.createElement('div');
    more.id = 'videos-more';
    more.className = 'col-span-full flex justify-center my-6';
    more.innerHTML = '<button class="px-4 py-2 border rounded-lg">Показать ещё</button>';
    grid.after(more);
    more.querySelector('button').onclick = ()=> load(currentCat, false);
  }
  more.style.display = canMore ? '' : 'none';
}


  btns.forEach(b => b.addEventListener('click', ()=> { lastCursor=null; load(b.dataset.cat, true); }));

  // старт
  await load('ПОСЛЕДНИЕ', true);

  // модалка
  document.getElementById("close-modal").addEventListener("click", () => {
    document.getElementById("video-modal").classList.add("hidden");
    document.getElementById("video-frame").src = "";
  });
</script>


<script>
(function(){
  ['terms-btn','support-btn','cooperation-btn','privacy-btn','menu-btn'].forEach(id=>{
    const el = document.getElementById(id);
    if(!el) return;
    const clone = el.cloneNode(true);
    el.parentNode.replaceChild(clone, el);
  });
  const modal=document.getElementById('modal-overlay');
  const title=document.getElementById('modal-title');
  const meta=document.getElementById('modal-meta');
  const content=document.getElementById('modal-content');
  const cover=document.getElementById('article-cover');
  function show(t,html){
    if(!modal||!title||!content) return;
    title.textContent=t; if(meta) meta.textContent='';
    if(cover){ cover.classList.add('hidden'); cover.src=''; }
    content.innerHTML=html; modal.classList.remove('hidden');
  }
  const TERMS=`<p>Используя сайт «На ТОПчане», вы соглашаетесь с правилами:</p>
  <ul class="list-disc pl-5 space-y-1">
    <li>Не размещать незаконный или оскорбительный контент.</li>
    <li>Не использовать сайт для рассылки спама или мошенничества.</li>
    <li>Соблюдать авторские права на публикуемый материал.</li>
    <li>Администрация может изменять условия без предварительного уведомления.</li>
    <li>При несогласии с условиями прекратите использование сайта.</li>
  </ul>`;
  const SUPPORT=`<p>По любым вопросам и предложениям вы можете написать нам:</p>
  <p class="flex items-center gap-2">
    <img src="/images/soc/telegram.svg" alt="Telegram" class="w-5 h-5">
    <a href="https://t.me/levakand_pro" target="_blank" class="text-blue-600 hover:underline">Написать в Telegram</a>
  </p>`;
  const COOP=`<p>По вопросам рекламы и совместных проектов свяжитесь с нами:</p>
  <p class="flex items-center gap-2">
    <img src="/images/soc/telegram.svg" alt="Telegram" class="w-5 h-5">
    <a href="https://t.me/levakand_pro" target="_blank" class="text-blue-600 hover:underline">Telegram</a>
  </p>
  <p class="flex items-center gap-2">
    <img src="/images/soc/gmail.svg" alt="Gmail" class="w-5 h-5">
    <a href="mailto:natopchane@gmail.com" class="text-red-600 hover:underline">natopchane@gmail.com</a>
  </p>`;
  const PRIV=`<p>Мы уважаем вашу конфиденциальность. При использовании сайта «На ТОПчане» мы можем собирать минимальные данные: IP-адрес, cookie, email (при подписке на рассылку).</p>
  <p>Данные используются для улучшения работы сайта, персонализации контента и статистики посещений.</p>
  <p>Мы не передаём ваши данные третьим лицам, кроме случаев, предусмотренных законом.</p>
  <p>Вы можете запросить удаление или изменение своих данных, написав нам на <a class="text-red-600 hover:underline" href="mailto:natopchane@gmail.com">natopchane@gmail.com</a>.</p>
  <p>Изменения политики публикуются на этой странице.</p>`;
  document.getElementById('terms-btn')?.addEventListener('click', ()=> show('Пользовательское соглашение', TERMS));
  document.getElementById('support-btn')?.addEventListener('click', ()=> show('Поддержка', SUPPORT));
  document.getElementById('cooperation-btn')?.addEventListener('click', ()=> show('Сотрудничество и реклама', COOP));
  document.getElementById('privacy-btn')?.addEventListener('click', ()=> show('Политика конфиденциальности', PRIV));
  document.getElementById('menu-btn')?.addEventListener('click', ()=>{
    document.getElementById('menu')?.classList.toggle('hidden');
  });
})();
</script>
<!-- Левый боковой баннер -->
<div class="ad-left">
<script type="text/javascript">
	atOptions = {
		'key' : '4cfa40489284c0efa9eb342e77152cdc',
		'format' : 'iframe',
		'height' : 300,
		'width' : 160,
		'params' : {}
	};
</script>
<script type="text/javascript" src="//www.highperformanceformat.com/4cfa40489284c0efa9eb342e77152cdc/invoke.js"></script>
</div>

<!-- Правый боковой баннер -->
<div class="ad-right">
<script type="text/javascript">
	atOptions = {
		'key' : '766301ab751df8665553f47e1f05709a',
		'format' : 'iframe',
		'height' : 600,
		'width' : 160,
		'params' : {}
	};
</script>
<script type="text/javascript" src="//www.highperformanceformat.com/766301ab751df8665553f47e1f05709a/invoke.js"></script>
</div>

</body>
</html>