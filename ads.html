<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Реклама - На ТОПчане</title>

  <!-- SEO -->
  <meta name="description" content="Витрина платных размещений и объявлений проекта «На ТОПчане». Лента реклам с карточками, лайками, просмотрами и шарингом."/>
  <link rel="canonical" href="ads.html"/>
  <meta property="og:type" content="website"/>
  <meta property="og:title" content="Реклама — На ТОПчане"/>
  <meta property="og:description" content="Лента рекламных карточек проекта «На ТОПчане»."/>
  <meta property="og:url" content="ads.html"/>
  <meta property="og:image" content="images/rec%20ic.svg"/>
  <meta name="theme-color" content="#e7e0d1"/>

  <!-- Favicon -->
  <link rel="icon" type="image/svg+xml" href="images/rec%20ic.svg"/>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Общие стили сайта -->
  <link rel="stylesheet" href="css/style.css">
  <style>
    /* Отличие от news: тёплая светло-беж фоновая тема и мягкие карточки */
    html{ background:#f7f3ec; }
    main{ padding-bottom:72px; } /* запас под фикс-подвал */
    .card{background:#fff;border:1px solid #e5e7eb;border-radius:18px;box-shadow:0 10px 30px rgba(0,0,0,.06)}
    .btn{display:inline-flex;align-items:center;gap:6px;border:1px solid #e5e7eb;border-radius:12px;padding:8px 12px;font-weight:600}
    .btn-ghost{background:#fff}
    .btn-like[aria-pressed="true"]{border-color:#fb7185;background:#fff1f2}
    .ads-wrap{max-width:820px;margin:0 auto}
    .article-modal{max-width:880px;width:100%}
    .article-scroll{max-height:80vh;overflow:auto}
    .article-cover{width:100%;height:340px;object-fit:cover;border-bottom:1px solid #e5e7eb;border-top-left-radius:16px;border-top-right-radius:16px}
  </style>
</head>
<body class="text-gray-900">

  <!-- ШАПКА (как на сайте) -->
  <header class="border-b border-gray-200 bg-white">
    <div class="w-full px-2 flex justify-between items-center h-16">
      <a href="index.html" class="flex items-center gap-2 text-xl font-semibold tracking-tight">
        <img src="images/logo.png" alt="На ТОПчане" class="h-8 w-8 object-contain">
        На ТОПчане
      </a>

      <nav class="hidden md:flex md:flex-1 justify-center items-center gap-8 whitespace-nowrap">
        <a href="index.html">Главная</a>
        <a href="news.html">Новости</a>
        <a href="ads.html" class="font-bold border-b-2 border-current">Реклама</a>
        <a href="gallery.html">Галерея</a>
        <a href="biographies.html">Биографии</a>
        <a href="music.html">Музыка</a>
        <a href="entertainment.html">Развлечения</a>
        <a href="products.html">Продукция</a>
        <a href="about.html">О нас</a>
        <a href="contacts.html">Контакты</a>
      </nav>

      <button id="menu-btn" class="md:hidden p-2 text-gray-700 text-2xl" aria-label="Меню">☰</button>
    </div>

    <!-- Мобильное меню -->
    <div id="menu" class="hidden flex-col gap-4 p-4 bg-gray-100 md:hidden">
      <a href="index.html">Главная</a>
      <a href="news.html">Новости</a>
      <a href="ads.html" class="font-bold">Реклама</a>
      <a href="gallery.html">Галерея</a>
      <a href="biographies.html">Биографии</a>
      <a href="music.html">Музыка</a>
      <a href="entertainment.html">Развлечения</a>
      <a href="products.html">Продукция</a>
      <a href="about.html">О нас</a>
      <a href="contacts.html">Контакты</a>
    </div>
  </header>

  <!-- HERO — REC + логотип + заголовок -->
<section class="bg-white border-b">
  <div class="max-w-7xl mx-auto px-2 ads-hero flex items-center gap-3">
    <img src="images/rec ic.svg logo.svg" alt="На ТОПчане" class="logo">
    <h1>РЕКЛАМА НА ТОПчане</h1>
  </div>
</section>


  <!-- Лёгкий премиум-акцент -->
  <section class="border-b" style="background:linear-gradient(180deg,#f2ede3, #f7f3ec)">
    <div class="max-w-7xl mx-auto px-4 py-4 flex flex-wrap items-center gap-3">
      <span class="inline-flex items-center gap-2 text-xs font-semibold tracking-widest uppercase rounded-full border px-3 py-1 bg-white">Витрина размещений</span>
      <span class="text-sm text-gray-600">Все объявления модерируются</span>
    </div>
  </section>

  <!-- ОСНОВНОЙ КОНТЕНТ -->
  <main class="max-w-7xl mx-auto px-4 py-6">
    <div id="ads-feed" class="ads-wrap space-y-6"></div>
    <div id="ads-empty" class="hidden text-sm text-gray-500 text-center">Пока пусто</div>
    <div id="ads-err" class="hidden text-sm text-red-600 mt-2 text-center"></div>

    <div class="flex justify-center my-6">
      <button id="ads-more" class="btn btn-ghost">Показать ещё</button>
    </div>
  </main>

  <!-- ПОДВАЛ (1:1 как на главной/новостях) -->
<footer class="fixed bottom-0 left-0 w-full border-t border-gray-200 bg-white">
  <div class="max-w-7xl mx-auto px-4 py-2 text-xs text-gray-500 flex flex-col md:flex-row justify-between items-center gap-2">
    <p>© 2025 На ТОПчане. Все права защищены.</p>

    <ul class="soc-row">
      <li><a href="https://vk.com/natopchane" target="_blank" aria-label="VK"><img src="images/soc/vk.svg" alt="VK"></a></li>
      <li><a href="https://t.me/na_topchane" target="_blank" aria-label="Telegram"><img src="images/soc/telegram.svg" alt="Telegram"></a></li>
      <li><a href="https://www.instagram.com/natopchane/" target="_blank" aria-label="Instagram"><img src="images/soc/instagram.svg" alt="Instagram"></a></li>
      <li><a href="https://www.tiktok.com/@natopchane" target="_blank" aria-label="TikTok"><img src="images/soc/tik-tok.svg" alt="TikTok"></a></li>
      <li><a href="https://www.pinterest.com/natopchane/?invite_code=67d18b04667e4a56b03fb7432127235b&sender=1144266355231499314" target="_blank" aria-label="Pinterest"><img src="images/soc/pinterest.svg" alt="Pinterest"></a></li>
      <li><a href="https://rutube.ru/channel/49549724/" target="_blank" aria-label="Rutube"><img src="images/soc/rutube.svg" alt="Rutube"></a></li>
      <li><a href="https://www.facebook.com/groups/natopchane/" target="_blank" aria-label="Facebook"><img src="images/soc/fb.svg" alt="Facebook"></a></li>
      <li><a href="https://dzen.ru/natopchane" target="_blank" aria-label="Dzen"><img src="images/soc/yandex.svg" alt="Dzen"></a></li>
      <li><a href="https://www.youtube.com/@natopchane" target="_blank" aria-label="YouTube"><img src="images/soc/youtube.svg" alt="YouTube"></a></li>
      <li><a href="https://ok.ru/group/70000013841187" target="_blank" aria-label="OK"><img src="images/soc/ok.svg" alt="OK"></a></li>
    </ul>

    <div class="flex flex-wrap gap-3">
      <button id="terms-btn" class="hover:underline">Пользовательское соглашение</button>
      <button id="support-btn" class="hover:underline">Поддержка</button>
      <button id="cooperation-btn" class="hover:underline">Сотрудничество</button>
      <button id="privacy-btn" class="hover:underline">Политика конфиденциальности</button>
    </div>
  </div>
</footer>


  <!-- УНИВЕРСАЛЬНАЯ МОДАЛКА -->
  <div id="modal-overlay" class="fixed inset-0 bg-black/50 hidden z-50 flex items-center justify-center p-4">
    <button id="prev-article" class="absolute left-4 md:left-6 top-1/2 -translate-y-1/2 bg-white/90 hover:bg-white rounded-full w-9 h-9 flex items-center justify-center shadow" aria-label="Предыдущая">‹</button>
    <button id="next-article" class="absolute right-4 md:right-6 top-1/2 -translate-y-1/2 bg-white/90 hover:bg-white rounded-full w-9 h-9 flex items-center justify-center shadow" aria-label="Следующая">›</button>

    <div id="modal-box" class="bg-white article-modal w-full max-w-[880px] p-0 rounded-2xl relative shadow-lg">
      <button id="modal-close" class="absolute top-3 right-3 text-gray-500 hover:text-gray-700 text-2xl leading-none" aria-label="Закрыть">&times;</button>

      <div class="article-scroll">
        <img id="article-cover" class="article-cover hidden" alt="">
        <div class="p-6">
          <h2 id="modal-title" class="text-2xl font-bold mb-1"></h2>
          <div class="flex flex-wrap items-center gap-3 mb-4">
            <div id="modal-meta" class="text-xs text-gray-500"></div>
            <div class="ml-auto flex items-center gap-2 text-xs">
              <button id="share-copy" class="btn btn-ghost py-1 px-2">Скопировать ссылку</button>
              <a id="share-tg" class="btn btn-ghost py-1 px-2" target="_blank" rel="noopener">TG</a>
              <a id="share-vk" class="btn btn-ghost py-1 px-2" target="_blank" rel="noopener">VK</a>
            </div>
          </div>
          <div id="modal-content" class="prose text-gray-800"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- FIREBASE + ЛОГИКА -->
  <script type="module">
    // ===== Firebase =====
    import { firebaseConfig } from './firebase-config.js';
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js';
    import {
      getFirestore, collection, getDocs, query, orderBy, limit, startAfter,
      doc, updateDoc, increment
    } from 'https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js';

    const app = initializeApp(firebaseConfig);
    const db  = getFirestore(app);

    // ===== Helpers / DOM =====
    const $ = (s,r=document)=>r.querySelector(s);
    const feedEl = $('#ads-feed'), emptyEl = $('#ads-empty'), errEl = $('#ads-err'), moreBtn = $('#ads-more');

    // Мобильное меню
    document.getElementById('menu-btn').addEventListener('click', () => {
      document.getElementById('menu').classList.toggle('hidden');
    });

    // Модалки (универсальная)
    const modal = document.getElementById('modal-overlay');
    const title = document.getElementById('modal-title');
    const content = document.getElementById('modal-content');

    // --- АЛИАСЫ, чтобы дальше код не падал ---
const overlay = modal;
const mTitle = title;
const mContent = content;
const mMeta = document.getElementById('modal-meta');
const mCover = document.getElementById('article-cover');
const aShareTG = document.getElementById('share-tg');
const aShareVK = document.getElementById('share-vk');
const btnShareCopy = document.getElementById('share-copy');

// --- ЗАКРЫТИЕ МОДАЛКИ ---
const closeBtn = document.getElementById('modal-close');
if (closeBtn) closeBtn.onclick = () => overlay.classList.add('hidden');

// клик по фону
overlay.addEventListener('click', (e) => {
  if (e.target === overlay) overlay.classList.add('hidden');
});

// Esc
document.addEventListener('keydown', (e) => {
  if (e.key === 'Escape') overlay.classList.add('hidden');
});

    document.getElementById('privacy-btn').onclick = () => {
      title.textContent = 'Политика конфиденциальности';
      content.innerHTML = `
        <p>Мы уважаем вашу конфиденциальность. При использовании сайта «На ТОПчане» мы можем собирать минимальные данные: IP-адрес, cookie, email (при подписке на рассылку).</p>
        <p>Данные используются для улучшения работы сайта, персонализации контента и статистики посещений.</p>
        <p>Мы не передаём ваши данные третьим лицам, кроме случаев, предусмотренных законом.</p>
        <p>Вы можете запросить удаление или изменение своих данных, написав нам на support@example.com.</p>
        <p>Изменения политики публикуются на этой странице.</p>
      `;
      modal.classList.remove('hidden');
    };

    document.getElementById('terms-btn').onclick = () => {
      title.textContent = 'Пользовательское соглашение';
      content.innerHTML = `
        <p>Используя сайт «На ТОПчане», вы соглашаетесь с правилами:</p>
        <ul class="list-disc pl-5 space-y-1">
          <li>Не размещать незаконный или оскорбительный контент.</li>
          <li>Не использовать сайт для рассылки спама или мошенничества.</li>
          <li>Соблюдать авторские права на публикуемый материал.</li>
          <li>Администрация может изменять условия без предварительного уведомления.</li>
        </ul>
        <p>При несогласии с условиями прекратите использование сайта.</p>
      `;
      modal.classList.remove('hidden');
    };

    document.getElementById('support-btn').onclick = () => {
      title.textContent = 'Поддержка';
      content.innerHTML = `
        <p>По любым вопросам и предложениям вы можете написать нам:</p>
        <p class="flex items-center gap-2">
          <img src="images/telegram.svg" alt="Telegram" class="w-5 h-5">
          <a href="https://t.me/levakand_pro" target="_blank" class="text-blue-600 hover:underline">Написать в Telegram</a>
        </p>
      `;
      modal.classList.remove('hidden');
    };

    document.getElementById('cooperation-btn').onclick = () => {
      title.textContent = 'Сотрудничество и реклама';
      content.innerHTML = `
        <p>По вопросам рекламы и совместных проектов свяжитесь с нами:</p>
        <p class="flex items-center gap-2">
          <img src="images/telegram.svg" alt="Telegram" class="w-5 h-5">
          <a href="https://t.me/levakand_pro" target="_blank" class="text-blue-600 hover:underline">Telegram</a>
        </p>
        <p class="flex items-center gap-2">
          <img src="images/gmail.svg" alt="Gmail" class="w-5 h-5">
          <a href="mailto:natopchane@gmail.com" class="text-red-600 hover:underline">natopchane@gmail.com</a>
        </p>
      `;
      modal.classList.remove('hidden');
    };

    // ===== Лента / пейджинг =====
    const pageSize = 12;
    let lastDoc = null;
    let cache = [];
    let currentIndex = -1;

    const esc = s => (s||'').toString().replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;');
    const cut = (t,max=260)=>{t=(t||'').toString().replace(/\s+/g,' ').trim();return t.length<=max?esc(t):esc(t.slice(0,max))+'…';}

    const liked = id => { try{return localStorage.getItem('ads_like_'+id)==='1'}catch{return false} };
    const markLiked = id => { try{localStorage.setItem('ads_like_'+id,'1')}catch{} };

    const card = (a)=>`
      <article class="card overflow-hidden" data-id="${a.id}">
        ${a.cover?`<img loading="lazy" src="${esc(a.cover)}" class="w-full h-56 object-cover border-b">`:''}
        <div class="p-5 space-y-3">
          <div class="flex items-start gap-2">
            <span class="inline-flex items-center gap-2 text-[10px] font-semibold tracking-widest uppercase rounded-full border px-2 py-0.5 bg-[#fff8]">Ad</span>
            <h3 class="font-bold text-lg leading-tight">${esc(a.title||'Без названия')}</h3>
          </div>
          ${a.desc?`<p class="text-sm text-gray-800">${cut(a.desc, 260)}</p>`:''}
          <div class="flex items-center justify-between">
            <button class="btn btn-ghost read-more" data-open="${a.id}">Подробнее</button>
            <div class="flex items-center gap-4 text-xs text-gray-600">
              <button class="btn btn-ghost btn-like" data-like="${a.id}" aria-pressed="${liked(a.id)}">❤️ <span class="like-count">${a.likes||0}</span></button>
              <span class="inline-flex items-center gap-1">👁 <span class="view-count">${a.views||0}</span></span>
            </div>
          </div>
        </div>
      </article>`;

    function render(list = cache){
      feedEl.innerHTML = list.map(card).join('');
    }

async function loadMore(){
  moreBtn.disabled = true;
  try {
    let q = query(collection(db, 'ads'), orderBy('createdAt', 'desc'), limit(pageSize));
    if (lastDoc) {
      q = query(collection(db, 'ads'), orderBy('createdAt', 'desc'), startAfter(lastDoc), limit(pageSize));
    }

    const snap = await getDocs(q);

    if (!snap.empty) {
      lastDoc = snap.docs[snap.docs.length - 1];
const arr = snap.docs
  .map(d => ({ id: d.id, ...d.data() }))
  .filter(a => (a.status || 'published') === 'published' && !a.__deleted);


      cache = cache.concat(arr);
      render();
      emptyEl.classList.add('hidden');
      moreBtn.classList.toggle('hidden', snap.size < pageSize);
    } else {
      if (!cache.length) emptyEl.classList.remove('hidden');
      moreBtn.classList.add('hidden');
    }
  } catch (e) {
    console.error(e);
    errEl.textContent = 'Ошибка загрузки витрины. Проверь firebase-config.js и доступы.';
    errEl.classList.remove('hidden');
  } finally {
    moreBtn.disabled = false;
  }
}

    // Делегирование кликов (карточки рендерятся динамически)
    document.addEventListener('click', async (e)=>{
      // Открыть карточку
      const openBtn = e.target.closest('[data-open]');
      if(openBtn){
        openAd(openBtn.dataset.open);
        return;
      }
      // Лайк
      const likeBtn = e.target.closest('[data-like]');
      if(likeBtn){
        const id = likeBtn.dataset.like;
        if(liked(id)) return;
        try{
          await updateDoc(doc(db,'ads',id), { likes: increment(1) });
          likeBtn.setAttribute('aria-pressed','true');
          likeBtn.querySelector('.like-count').textContent =
            String((+likeBtn.querySelector('.like-count').textContent||0)+1);
          markLiked(id);
        }catch(err){ console.warn('like++ fail', err?.code||err?.message||err); }
      }
    });

    // Безопасный инкремент просмотров
    async function incViewsSafe(id){
      try{ await updateDoc(doc(db,'ads', id), { views: increment(1) }); }
      catch(e){ console.warn('views++ fail', e?.code||e?.message||e); }
    }

    function openAd(id){
      if(!id) return;
      const idx = cache.findIndex(x=>x.id===id);
      if(idx<0) return;
      currentIndex = idx;

      const a = cache[idx] || {};
      mTitle.textContent = a.title || 'Без названия';
      mMeta.textContent  = (a.createdAt || '').toString().slice(0,10);
      mContent.innerHTML = esc(a.desc || '');

      if(a.cover){ mCover.src = a.cover; mCover.classList.remove('hidden'); }
      else { mCover.classList.add('hidden'); mCover.src=''; }

      const url = location.origin + location.pathname + '#ad=' + encodeURIComponent(id);
      if (aShareTG) aShareTG.href = 'https://t.me/share/url?url=' + encodeURIComponent(url) + '&text=' + encodeURIComponent(a.title||'');
      if (aShareVK) aShareVK.href = 'https://vk.com/share.php?url=' + encodeURIComponent(url);
      if (btnShareCopy) btnShareCopy.onclick = async ()=>{
        try{ await navigator.clipboard.writeText(url);
             btnShareCopy.textContent='Скопировано';
             setTimeout(()=>btnShareCopy.textContent='Скопировать ссылку',1500);
        }catch{}
      };

      overlay.classList.remove('hidden');
      incViewsSafe(id);
    }

    function openByOffset(off){
      if(!cache.length) return;
      if(currentIndex<0) currentIndex = 0;
      currentIndex = (currentIndex + off + cache.length) % cache.length;
      openAd(cache[currentIndex].id);
    }
    $('#prev-article').onclick = ()=> openByOffset(-1);
    $('#next-article').onclick = ()=> openByOffset(1);

    // Хэш-доступ #ad=ID
    function openFromHash(){
      const m = location.hash.match(/ad=([^&]+)/);
      if(m){ const id = decodeURIComponent(m[1]); const t = setInterval(()=>{
          if(cache.length){ clearInterval(t); openAd(id); }
        },100); setTimeout(()=>clearInterval(t), 5000);
      }
    }

    // Инициализация
    moreBtn.onclick = loadMore;
    await loadMore();
    openFromHash();
  </script>
</body>
</html>
